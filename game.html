<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voice Dino Game</title>
  <style>
    body { margin: 0; overflow: hidden; background: #f4f4f4; font-family: sans-serif; }
    canvas { display: block; margin: auto; background: #fff; border: 2px solid #222; }
    #restartBtn, #modeToggle {
      position: absolute;
      top: 10px;
      font-size: 16px;
      padding: 8px 16px;
      z-index: 10;
    }
    #restartBtn {
      left: 50%;
      transform: translateX(-50%);
      display: none;
    }
    #modeToggle {
      right: 10px;
    }
  </style>
</head>
<body>
  <canvas id="game" width="480" height="240"></canvas>
  <button id="restartBtn">Restart Game</button>
  <button id="modeToggle">Mode: Loudness</button>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const restartBtn = document.getElementById("restartBtn");
    const modeToggle = document.getElementById("modeToggle");

    let speed = 2, gameStartTime = 0, frame = 0, nextSpawn = 0;
    let gameRunning = true, animationId = null;
    let controlMode = "loudness"; // "pitch" or "loudness"
    const obstacles = [];

    const dino = {
      x: 50, y: 160, w: 30, h: 40,
      vy: 0, gravity: 0.8, jumpForce: -12,
      crouch: false, jumping: false,
      update() {
        this.vy += this.gravity;
        this.y += this.vy;
        if (this.y > 160) {
          this.y = 160;
          this.vy = 0;
          this.jumping = false;
        }
        this.h = this.crouch ? 20 : 40;
      },
      jump() {
        if (!this.jumping) {
          this.vy = this.jumpForce;
          this.jumping = true;
        }
      }
    };

    function spawnObstacle() {
      const type = Math.random() < 0.5 ? "ground" : "flying";
      const h = 20 + (type === "ground" ? Math.random() * 30 : 0);
      const y = type === "ground" ? 200 - h : 120 + Math.random() * 40;
      obstacles.push({ x: canvas.width, y, w: 20, h, type });
    }

    function updateObstacles() {
      for (let obs of obstacles) obs.x -= speed;
      if (frame >= nextSpawn) {
        spawnObstacle();
        nextSpawn = frame + 90 + Math.floor(Math.random() * 60);
      }
    }

    function drawGameOver() {
      ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.font = "24px Arial";
      ctx.fillText("Game Over!", 160, 100);
      ctx.font = "16px Arial";
      ctx.fillText("Tap 'Restart' or make noise to try again!", 90, 140);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#2ecc71";
      ctx.fillRect(dino.x, dino.y + (40 - dino.h), dino.w, dino.h);
      ctx.fillStyle = "#e74c3c";
      for (let obs of obstacles) {
        ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
      }
      ctx.fillStyle = "#555";
      ctx.fillRect(0, 200, canvas.width, 5);
      if (!gameRunning) drawGameOver();
    }

    function checkCollision() {
      for (let obs of obstacles) {
        if (
          dino.x < obs.x + obs.w &&
          dino.x + dino.w > obs.x &&
          dino.y + (40 - dino.h) < obs.y + obs.h &&
          dino.y + (40 - dino.h) + dino.h > obs.y
        ) {
          gameRunning = false;
          restartBtn.style.display = "block";
        }
      }
    }

    function resetGame() {
      if (animationId) cancelAnimationFrame(animationId);
      gameRunning = true;
      speed = 2;
      gameStartTime = performance.now();
      frame = 0;
      nextSpawn = 0;
      obstacles.length = 0;
      Object.assign(dino, { y: 160, vy: 0, jumping: false, crouch: false });
      restartBtn.style.display = "none";
      gameLoop();
    }

    function gameLoop() {
      if (gameRunning) {
        dino.update();
        updateObstacles();
        checkCollision();
        const elapsed = (performance.now() - gameStartTime) / 1000;
        speed = 2 + elapsed * 0.05;
      }
      draw();
      frame++;
      animationId = requestAnimationFrame(gameLoop);
    }

    restartBtn.onclick = resetGame;

    // ðŸŽ¤ Mic logic
    async function initMicControl() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      const data = new Float32Array(analyser.fftSize);

      function getPitch() {
        analyser.getFloatTimeDomainData(data);
        let bestOffset = -1, bestCorr = 0, rms = 0;
        for (let i = 0; i < data.length; i++) rms += data[i] * data[i];
        rms = Math.sqrt(rms / data.length);
        if (rms < 0.01) return -1;
        for (let offset = 32; offset < 512; offset++) {
          let corr = 0;
          for (let i = 0; i < 512; i++) {
            corr += data[i] * data[i + offset];
          }
          corr /= 512;
          if (corr > bestCorr) {
            bestCorr = corr;
            bestOffset = offset;
          }
        }
        if (bestCorr > 0.01) {
          return audioCtx.sampleRate / bestOffset;
        }
        return -1;
      }

      function micLoop() {
        if (!gameRunning) return setTimeout(micLoop, 50);

        analyser.getFloatTimeDomainData(data);
        let rms = 0;
        for (let i = 0; i < data.length; i++) {
          rms += data[i] * data[i];
        }
        rms = Math.sqrt(rms / data.length);

        if (controlMode === "loudness") {
          if (rms > 0.08) {
            dino.jump();
          } else if (rms > 0.02) {
            dino.crouch = true;
          } else {
            dino.crouch = false;
          }
        } else if (controlMode === "pitch") {
          const pitch = getPitch();
          if (pitch > 300) {
            dino.jump();
          } else if (pitch > 50 && pitch < 150) {
            dino.crouch = true;
          } else {
            dino.crouch = false;
          }
        }

        setTimeout(micLoop, 50);
      }

      micLoop();
    }

    modeToggle.onclick = () => {
      controlMode = controlMode === "loudness" ? "pitch" : "loudness";
      modeToggle.textContent = `Mode: ${controlMode.charAt(0).toUpperCase() + controlMode.slice(1)}`;
    };

    initMicControl();
    resetGame();
  </script>
</body>
</html>
